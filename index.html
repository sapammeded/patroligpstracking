<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Patroli GPS — Final (Modal Fixed)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{--bg:#f5f7fb;--card:#fff;--primary:#0b69ff;--muted:#6b7280;--danger:#ef4444;}
  *{box-sizing:border-box}
  body{margin:0;padding:0;background:var(--bg);color:#111;font-family:Inter,system-ui,Roboto,Arial}
  header{background:linear-gradient(90deg,#0b1228,#082046);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  header h1{font-size:18px;margin:0;font-weight:600}
  .container{padding:18px;max-width:1200px;margin:18px auto;display:flex;gap:16px;flex-wrap:wrap}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 24px rgba(7,10,25,0.06)}
  .sidebar{width:300px;min-width:260px}
  .muted{color:var(--muted);font-size:13px}
  label{display:block;margin:10px 0 6px;font-weight:600}
  input[type=text], input[type=password], textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e9ef;font-size:14px;background:#fbfdff}
  textarea{min-height:90px;resize:vertical;text-align:left}
  .topbar-controls{display:flex;gap:10px;align-items:center}
  .btn{background:var(--primary);color:#fff;border:0;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(11,105,255,0.12)}
  .btn.danger{background:var(--danger)}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:8px 10px;border-radius:10px;background:#eef2ff;color:var(--primary);cursor:pointer;font-weight:600}
  .areas{margin-top:12px}
  .area{border-radius:10px;padding:12px;margin-bottom:12px;border:1px solid #eef2f6;background:linear-gradient(180deg,#fff,#fbfdff)}
  .area-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
  .area-title{font-size:15px;font-weight:700}
  .area-actions{display:flex;gap:8px;align-items:center}
  .photo-controls{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .photos{display:flex;gap:8px;flex-wrap:wrap}
  .photo-item{width:120px;height:90px;border-radius:8px;overflow:hidden;position:relative;background:#f3f4f6;border:1px solid #e7eefb}
  .photo-item img{width:100%;height:100%;object-fit:cover;display:block}
  .photo-item .actions{position:absolute;left:6px;bottom:6px;display:flex;gap:6px}
  .icon-btn{background:rgba(255,255,255,0.98);border-radius:6px;padding:6px;font-size:12px;border:0;cursor:pointer}
  .icon-pencil{color:#0b1228}
  .icon-trash{color:#b91c1c}
  .signature-canvas{border:1px solid #e6e9ef;border-radius:8px;touch-action:none;background:#fff;display:block}
  .sig-thumb{width:140px;height:60px;border:1px solid #e6e9ef;border-radius:6px;overflow:hidden;background:#fff;display:inline-block}
  .note{font-size:13px;color:var(--muted);margin-top:8px}

  /* Modal styles */
  .modal-backdrop{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal-backdrop.hidden{display:none;pointer-events:none}
  .modal-backdrop.visible{display:flex;pointer-events:auto}
  .modal{background:#fff;padding:18px;border-radius:10px;max-width:460px;width:92%;box-shadow:0 12px 40px rgba(2,6,23,0.3)}
  .modal h3{margin:0 0 8px}
  .muted-sm{font-size:13px;color:#6b7280}
  .modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  /* make backdrop clickable area dim but not blocking when hidden */
  .modal-backdrop .backdrop-layer{position:absolute;inset:0;background:rgba(6,8,20,0.45)}
  .modal-inner{position:relative;z-index:2}
  @media(max-width:880px){ .sidebar{width:100%} }
</style>
</head>
<body>
<header>
  <h1>Patroli GPS — Final (Modal Fixed)</h1>
  <div class="topbar-controls">
    <span id="trackStatus" class="muted">GPS: belum aktif</span>
    <button id="btnStartTrack" class="btn">Mulai Tracking</button>
    <button id="btnStopTrack" class="btn hidden">Stop</button>
    <button id="btnGeneratePDF" class="btn">Generate PDF</button>
    <button id="btnDeepClean" class="btn danger">Deep Clean-up</button>
  </div>
</header>

<div class="container">
  <aside class="card sidebar" role="complementary">
    <div>
      <label>Mode</label>
      <div style="display:flex;gap:8px">
        <button id="btnModeUser" class="btn ghost">User Biasa</button>
        <button id="btnModeAdmin" class="btn ghost">Admin</button>
      </div>

      <div id="adminLoginBox" style="margin-top:12px;" class="hidden">
        <label>Masuk Admin</label>
        <input id="adminPassword" type="password" placeholder="Masukkan password admin...">
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="btnAdminLogin" class="btn">Login</button>
          <button id="btnAdminLogout" class="btn danger hidden">Logout</button>
        </div>
        <div class="note">Password disimpan aman di memori — tidak ditampilkan di layar. Untuk reset gunakan Deep Clean-up.</div>
      </div>
    </div>

    <hr style="margin:12px 0">

    <div>
      <label>Petugas (nama)</label>
      <input id="officerName" type="text" placeholder="Nama petugas...">
      <label>Shift</label>
      <input id="shift" type="text" placeholder="Shift (contoh: Malam)">
      <label>Tanggal</label>
      <input id="tanggal" type="text" placeholder="YYYY-MM-DD">
      <div style="margin-top:10px" class="muted">GPS coords terkini:</div>
      <div id="coords" class="small">—</div>
    </div>

    <hr style="margin:12px 0">

    <div>
      <label>Tambah Area Patroli</label>
      <input id="areaName" type="text" placeholder="Nama area...">
      <div style="margin-top:8px">
        <button id="btnAddArea" class="btn">Tambah Area</button>
      </div>
    </div>

    <div style="margin-top:12px" class="note">Semua data hanya tersimpan sementara di memori. Deep Clean-up akan menghapus semua data & password.</div>
  </aside>

  <main class="card" role="main" style="flex:1 1 720px">
    <div class="tabs">
      <div class="tab" id="tabAreas">Daftar Area</div>
      <div class="tab" id="tabSignature">Tanda Tangan</div>
    </div>

    <section id="areasSection">
      <div style="margin-bottom:10px" class="note">Foto untuk tiap area <b>unlimited</b>. User biasa hanya dapat ambil foto via <b>kamera</b>. Admin dapat pilih kamera atau galeri.</div>
      <div class="areas" id="areas"></div>
    </section>

    <section id="signatureSection" class="hidden">
      <label>Nama pada tanda tangan</label>
      <input id="sigName" type="text" placeholder="Nama lengkap...">
      <label style="margin-top:8px">Tanda tangan (scroll akan dinonaktifkan saat menulis)</label>
      <div style="position:relative;margin-top:8px">
        <canvas id="sigCanvas" class="signature-canvas" width="720" height="140"></canvas>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <button id="btnClearSig" class="btn danger">Hapus</button>
        <button id="btnSaveSig" class="btn">Simpan Tanda Tangan</button>
        <div style="margin-left:16px">
          <div class="muted-sm">Preview:</div>
          <div id="sigPreview" class="sig-thumb"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Deep clean modal (backdrop + layer). Hidden by default -->
<div id="deepCleanModal" class="modal-backdrop hidden" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="backdrop-layer" aria-hidden="true"></div>
  <div class="modal modal-inner" role="document" aria-label="Deep Clean-up dialog">
    <h3>DEEP CLEAN-UP</h3>
    <p class="muted-sm">Hapus SEMUA DATA termasuk: Semua area patroli, semua foto, logo, tanda tangan, password akses. Aplikasi akan kembali seperti baru!</p>
    <div class="modal-footer">
      <button id="btnCancelDeep" class="btn ghost">Batal</button>
      <button id="btnConfirmDeep" class="btn danger">OK — Hapus Semua</button>
    </div>
  </div>
</div>

<template id="areaTemplate">
  <div class="area">
    <div class="area-header">
      <div style="display:flex;align-items:center;gap:8px">
        <div class="area-title"></div>
        <div class="muted small area-created"></div>
      </div>
      <div class="area-actions">
        <button class="icon-btn edit-area" title="Edit nama area"><i class="fa fa-pen icon-pencil"></i></button>
        <button class="icon-btn delete-area" title="Hapus area"><i class="fa fa-trash icon-trash"></i></button>
      </div>
    </div>

    <div class="photo-controls">
      <div class="photo-upload-box"></div>
      <div class="muted small">Jumlah foto: <span class="photo-count">0</span></div>
    </div>

    <div class="photos"></div>

    <div class="desc-row">
      <label>Deskripsi Area (rata kiri)</label>
      <textarea class="area-desc" placeholder="Isi deskripsi area..."></textarea>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn btn-save-desc"><i class="fa fa-save"></i> Simpan Deskripsi</button>
      </div>
    </div>
  </div>
</template>

<script>
/* ===== Patrol app modal-fixed version ===== */
(function(){
  // default admin password in memory (not shown). Null means no password set.
  window.__patrol_admin_password = (typeof window.__patrol_admin_password === 'undefined') ? 'raja123' : window.__patrol_admin_password;

  const state = { mode:'user', isAdminLogged:false, areas:[], gpsPath:[], signatureDataUrl:null };

  // DOM refs
  const areasEl = document.getElementById('areas');
  const tpl = document.getElementById('areaTemplate').content;
  const coordsEl = document.getElementById('coords');
  const trackStatus = document.getElementById('trackStatus');
  const btnStartTrack = document.getElementById('btnStartTrack');
  const btnStopTrack  = document.getElementById('btnStopTrack');
  const btnAddArea = document.getElementById('btnAddArea');
  const areaNameInput = document.getElementById('areaName');
  const btnModeUser = document.getElementById('btnModeUser');
  const btnModeAdmin = document.getElementById('btnModeAdmin');
  const adminLoginBox = document.getElementById('adminLoginBox');
  const btnAdminLogin = document.getElementById('btnAdminLogin');
  const btnAdminLogout = document.getElementById('btnAdminLogout');
  const adminPasswordInput = document.getElementById('adminPassword');
  const officerName = document.getElementById('officerName');
  const shiftInput = document.getElementById('shift');
  const tanggalInput = document.getElementById('tanggal');
  const btnGeneratePDF = document.getElementById('btnGeneratePDF');
  const btnDeepClean = document.getElementById('btnDeepClean');

  const deepCleanModal = document.getElementById('deepCleanModal');
  const btnCancelDeep = document.getElementById('btnCancelDeep');
  const btnConfirmDeep = document.getElementById('btnConfirmDeep');
  const backdropLayer = deepCleanModal ? deepCleanModal.querySelector('.backdrop-layer') : null;

  const tabAreas = document.getElementById('tabAreas');
  const tabSignature = document.getElementById('tabSignature');
  const areasSection = document.getElementById('areasSection');
  const signatureSection = document.getElementById('signatureSection');

  const sigCanvas = document.getElementById('sigCanvas');
  const sigName = document.getElementById('sigName');
  const btnClearSig = document.getElementById('btnClearSig');
  const btnSaveSig = document.getElementById('btnSaveSig');
  const sigPreview = document.getElementById('sigPreview');

  // utils
  const uid = (p='id') => p + '-' + Math.random().toString(36).slice(2,9);
  function revoke(url){ try{ URL.revokeObjectURL(url); }catch(e){} }

  // ensure modal functions robustly attached (used below and reattaches on DOMContentLoaded)
  function attachDeepCleanHandlers(){
    // safe-guard: detach first to avoid double-binding
    try { btnCancelDeep.onclick = null; btnConfirmDeep.onclick = null; } catch(e){}
    // Cancel: hide modal
    btnCancelDeep.addEventListener('click', function onCancel(e){
      hideDeepClean();
    });
    // OK: perform deep-clean
    btnConfirmDeep.addEventListener('click', function onConfirm(e){
      try {
        // revoke object URLs
        state.areas.forEach(a=> a.photos.forEach(p=> { try{ revoke(p.url);}catch(e){} }));
        // reset state
        state.areas = []; state.gpsPath = []; state.signatureDataUrl = null; state.isAdminLogged = false;
        // remove admin password
        window.__patrol_admin_password = null;
        // reset inputs
        try{ adminPasswordInput.value=''; }catch(e){}
        try{ officerName.value=''; shiftInput.value=''; tanggalInput.value=''; }catch(e){}
        // update UI
        renderAreas();
        hideDeepClean();
        alert('Deep Clean-up selesai. Semua data & password dihapus.');
      } catch(err){
        console.error('Deep clean failed', err);
        alert('Deep Clean gagal — lihat console.');
        hideDeepClean();
      }
    });
    // allow clicking the dim backdrop to cancel
    if(backdropLayer){
      backdropLayer.addEventListener('click', function(){ hideDeepClean(); });
    }
    // Esc to close
    window.addEventListener('keydown', function(ev){
      if(ev.key === 'Escape' && deepCleanModal && deepCleanModal.classList.contains('visible')){
        hideDeepClean();
      }
    });
    // small safety: if modal is stuck visible without pointer-events, enable pointer-events
    // (this can fix some race conditions)
    if(deepCleanModal){
      deepCleanModal.classList.remove('stuck');
    }
  }

  function showDeepClean(){
    if(!deepCleanModal) return;
    deepCleanModal.classList.remove('hidden');
    deepCleanModal.classList.add('visible');
    deepCleanModal.setAttribute('aria-hidden','false');
    // ensure focus on cancel for safety
    try{ btnCancelDeep && btnCancelDeep.focus(); }catch(e){}
  }
  function hideDeepClean(){
    if(!deepCleanModal) return;
    deepCleanModal.classList.remove('visible');
    deepCleanModal.classList.add('hidden');
    deepCleanModal.setAttribute('aria-hidden','true');
    // restore scrolling
    document.body.style.overflow = '';
    document.documentElement.style.overflow = '';
  }

  // fallback forced removal (exposed for debugging)
  window.forceRemoveDeepCleanModal = function(){
    try {
      if(deepCleanModal && deepCleanModal.parentNode) deepCleanModal.parentNode.removeChild(deepCleanModal);
      document.body.style.overflow = ''; document.documentElement.style.overflow = '';
      console.log('forceRemoveDeepCleanModal: modal element removed.');
    } catch(e){ console.error(e); }
  };

  // area functions
  function addArea(name){
    const id = uid('area');
    const area = { id, name: name || ('Area '+(state.areas.length+1)), photos:[], description:'', createdAt: Date.now()};
    state.areas.push(area);
    renderAreas();
  }
  function editAreaName(id){
    const a = state.areas.find(x=>x.id===id); if(!a) return;
    const v = prompt('Edit nama area:', a.name); if(v!==null){ a.name = v; renderAreas(); }
  }
  function deleteArea(id){
    if(!confirm('Hapus area ini dan semua fotonya?')) return;
    const idx = state.areas.findIndex(x=>x.id===id); if(idx>=0){ state.areas[idx].photos.forEach(p=> revoke(p.url)); state.areas.splice(idx,1); renderAreas(); }
  }

  // files
  function createFileInput(opts){
    const inp = document.createElement('input');
    inp.type = 'file'; inp.accept='image/*';
    if(opts.multiple) inp.multiple = true;
    if(!opts.allowGallery) inp.setAttribute('capture','environment');
    inp.dataset.areaId = opts.areaId || '';
    inp.style.display = 'none';
    document.body.appendChild(inp);
    inp.addEventListener('change', function(e){
      const files = Array.from(e.target.files || []);
      try{ opts.onChange && opts.onChange(files); }catch(er){ console.warn(er); }
      setTimeout(()=>{ try{ document.body.removeChild(inp);}catch(e){} }, 400);
    });
    return inp;
  }
  function handleFilesSelected(areaId, files){
    const a = state.areas.find(x=>x.id===areaId); if(!a) return;
    files.forEach(f => { const pid = uid('photo'); const url = URL.createObjectURL(f); a.photos.push({id:pid, file:f, url, desc:''}); });
    renderAreas();
  }

  // render
  function renderAreas(){
    if(!areasEl) return;
    areasEl.innerHTML = '';
    state.areas.forEach(area=>{
      const node = tpl.cloneNode(true);
      const el = node.querySelector('.area');
      el.querySelector('.area-title').innerText = area.name;
      el.querySelector('.area-created').innerText = ' • '+ new Date(area.createdAt).toLocaleString();

      // edit/delete
      const editBtn = el.querySelector('.edit-area');
      const delBtn = el.querySelector('.delete-area');
      editBtn.onclick = ()=> editAreaName(area.id);
      delBtn.onclick = ()=> deleteArea(area.id);

      // upload controls
      const uploadBox = el.querySelector('.photo-upload-box');
      uploadBox.innerHTML = '';
      if(state.isAdminLogged){
        const g = document.createElement('button'); g.className='btn ghost'; g.innerText='Pilih dari Galeri (multiple)';
        g.onclick = ()=> { const inp = createFileInput({allowGallery:true,multiple:true,areaId:area.id, onChange: files=> handleFilesSelected(area.id, files)}); inp.click(); };
        const c = document.createElement('button'); c.className='btn ghost'; c.innerText='Ambil Foto (kamera)';
        c.onclick = ()=> { const inp = createFileInput({allowGallery:false,multiple:false,areaId:area.id, onChange: files=> handleFilesSelected(area.id, files)}); inp.click(); };
        uploadBox.appendChild(g); uploadBox.appendChild(c);
      } else {
        const c = document.createElement('button'); c.className='btn ghost'; c.innerText='Ambil Foto (kamera)';
        c.onclick = ()=> { const inp = createFileInput({allowGallery:false,multiple:false,areaId:area.id, onChange: files=> handleFilesSelected(area.id, files)}); inp.click(); };
        uploadBox.appendChild(c);
      }

      // photos
      const photosEl = el.querySelector('.photos');
      el.querySelector('.photo-count').innerText = area.photos.length;
      area.photos.forEach(p=>{
        const item = document.createElement('div'); item.className='photo-item';
        const img = document.createElement('img'); img.src = p.url; item.appendChild(img);
        const actions = document.createElement('div'); actions.className='actions';
        const btnDel = document.createElement('button'); btnDel.className='icon-btn'; btnDel.innerHTML = '<i class="fa fa-trash icon-trash"></i>';
        btnDel.onclick = (ev)=>{ ev.stopPropagation(); if(confirm('Hapus foto?')){ const idx = area.photos.findIndex(x=>x.id===p.id); if(idx>=0){ revoke(area.photos[idx].url); area.photos.splice(idx,1); renderAreas(); } } };
        const btnEdit = document.createElement('button'); btnEdit.className='icon-btn'; btnEdit.innerHTML = '<i class="fa fa-pen icon-pencil"></i>';
        btnEdit.onclick = (ev)=>{ ev.stopPropagation(); const v = prompt('Deskripsi (tidak dibatasi):', p.desc||''); if(v!==null){ p.desc = v; renderAreas(); } };
        actions.appendChild(btnDel); actions.appendChild(btnEdit);
        item.appendChild(actions);
        if(p.desc && p.desc.length>0){ const d=document.createElement('div'); d.style.padding='6px'; d.style.textAlign='left'; d.style.fontSize='13px'; d.innerText = p.desc; item.appendChild(d); }
        photosEl.appendChild(item);
      });

      const descTa = el.querySelector('.area-desc');
      descTa.value = area.description || '';
      descTa.oninput = ()=> area.description = descTa.value;
      el.querySelector('.btn-save-desc').onclick = ()=> { area.description = descTa.value; alert('Deskripsi area disimpan'); };

      areasEl.appendChild(el);
    });
  }

  // GPS
  let watchId = null;
  function startTracking(){
    if(!navigator.geolocation){ alert('Geolocation tidak tersedia'); return; }
    trackStatus.innerText = 'GPS: aktif (mengambil lokasi...)'; btnStartTrack.classList.add('hidden'); btnStopTrack.classList.remove('hidden');
    watchId = navigator.geolocation.watchPosition(pos=> {
      const lat = pos.coords.latitude, lon = pos.coords.longitude;
      coordsEl.innerText = lat.toFixed(6)+', '+lon.toFixed(6)+' • '+ new Date(pos.timestamp).toLocaleTimeString();
      state.gpsPath.push({lat,lon,timestamp: pos.timestamp});
    }, err=> { console.warn(err); trackStatus.innerText = 'GPS: error/izin'; }, {enableHighAccuracy:true, maximumAge:2000, timeout:8000});
  }
  function stopTracking(){ if(watchId && navigator.geolocation) navigator.geolocation.clearWatch(watchId); watchId=null; trackStatus.innerText='GPS: dihentikan'; btnStartTrack.classList.remove('hidden'); btnStopTrack.classList.add('hidden'); }

  // signature canvas
  const ctx = sigCanvas.getContext('2d'); let drawing=false, lastPos=null;
  function getPos(ev){ const r = sigCanvas.getBoundingClientRect(); const x = (ev.touches?ev.touches[0].clientX:ev.clientX)-r.left; const y = (ev.touches?ev.touches[0].clientY:ev.clientY)-r.top; return {x,y}; }
  function sDown(e){ drawing=true; lastPos=getPos(e); e.preventDefault(); document.body.style.overflow='hidden'; }
  function sMove(e){ if(!drawing) return; const p=getPos(e); ctx.beginPath(); ctx.moveTo(lastPos.x,lastPos.y); ctx.lineTo(p.x,p.y); ctx.lineCap='round'; ctx.lineWidth=2.6; ctx.strokeStyle='#111'; ctx.stroke(); lastPos=p; e.preventDefault(); }
  function sUp(e){ drawing=false; lastPos=null; document.body.style.overflow=''; }
  sigCanvas.addEventListener('mousedown', sDown); sigCanvas.addEventListener('mousemove', sMove); sigCanvas.addEventListener('mouseup', sUp);
  sigCanvas.addEventListener('touchstart', sDown, {passive:false}); sigCanvas.addEventListener('touchmove', sMove, {passive:false}); sigCanvas.addEventListener('touchend', sUp);

  btnClearSig.onclick = ()=>{ ctx.clearRect(0,0,sigCanvas.width,sigCanvas.height); state.signatureDataUrl=null; sigPreview.innerHTML=''; };
  btnSaveSig.onclick = ()=>{ const url = sigCanvas.toDataURL('image/png'); state.signatureDataUrl = url; sigPreview.innerHTML = '<img src="'+url+'" style="width:140px;height:60px;object-fit:contain">'; alert('Tanda tangan tersimpan'); };

  // PDF generation (ke blob)
  async function generatePDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'mm', format:'a4'});
    const officer = officerName.value || 'Petugas'; const shift = shiftInput.value || ''; const tanggal = tanggalInput.value || new Date().toISOString().slice(0,10); const waktu = new Date().toLocaleTimeString();
    try {
      const profile = await captureProfilePhoto(state.isAdminLogged);
      if(profile){ const imgData = await fileToDataUrl(profile); doc.setFillColor(12,37,79); doc.rect(10,10,190,34,'F'); doc.setTextColor(255,255,255); doc.setFontSize(14); doc.text(officer,14,28); doc.setFontSize(10); doc.text('Shift: '+shift+' • '+tanggal+' • '+waktu,14,36); try{ const props = doc.getImageProperties(imgData); const w = 48; const h = (props.height/props.width)*w; doc.addImage(imgData,'PNG',150,12,w,h);}catch(e){console.warn(e);} } else { doc.setFontSize(12); doc.text(officer,14,28); doc.setFontSize(10); doc.text('Shift: '+shift+' • '+tanggal+' • '+waktu,14,36); }
    } catch(e){ console.warn('profile capture', e); }
    doc.addPage();
    for(const a of state.areas){
      doc.setFontSize(13); doc.text('Area: '+a.name,12,18); doc.setFontSize(10); const lines = doc.splitTextToSize(a.description||'',180); doc.text(lines,12,26); let y = 26 + (lines.length*5);
      for(const p of a.photos){
        if(y>250){ doc.addPage(); y=20; }
        try {
          const data = await urlToDataUrl(p.url);
          const props = doc.getImageProperties(data);
          const pw = 60; const ph = (props.height/props.width)*pw;
          doc.addImage(data,'JPEG',12,y,pw,ph);
          if(p.desc && p.desc.length>0){ doc.setFontSize(9); doc.text(p.desc,12+pw+6,y+6,{maxWidth:180-pw-12}); }
          y += Math.max(ph,36)+8;
        } catch(e){ console.warn(e); }
      }
      doc.addPage();
    }
    doc.setFontSize(12); doc.text('Tanda Tangan Petugas:',12,30); if(state.signatureDataUrl){ try{ doc.addImage(state.signatureDataUrl,'PNG',12,38,80,30); }catch(e){console.warn('sig add',e);} }
    doc.setLineWidth(0.6); doc.line(12,80,110,80); doc.setFontSize(11); doc.text(officer,12,88);
    doc.setFontSize(9); doc.text('GPS path (latest 10):',12,100); const gpsSample = state.gpsPath.slice(-10).map(g=>`${g.lat.toFixed(6)},${g.lon.toFixed(6)} @ ${new Date(g.timestamp).toLocaleString()}`); doc.setFontSize(8); doc.text(doc.splitTextToSize(gpsSample.join('\n'),180),12,106);
    const ab = doc.output('arraybuffer'); const blob = new Blob([ab],{type:'application/pdf'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'laporan_patroli_'+(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'_')+'.pdf'; document.body.appendChild(a); a.click();
    setTimeout(()=>{ try{ document.body.removeChild(a); URL.revokeObjectURL(url);}catch(e){} },1500);
  }

  // helpers: capture profile camera/gallery
  async function captureProfilePhoto(allowGallery){
    return new Promise(resolve=>{
      const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*'; if(!allowGallery) inp.setAttribute('capture','environment'); inp.style.display='none'; document.body.appendChild(inp);
      inp.addEventListener('change', function(e){ const f = e.target.files && e.target.files[0]; try{ document.body.removeChild(inp);}catch(e){}; resolve(f||null); });
      inp.click(); setTimeout(()=>{ try{ if(document.body.contains(inp)) document.body.removeChild(inp);}catch(e){}; resolve(null); },30000);
    });
  }
  function fileToDataUrl(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
  function urlToDataUrl(url){ return fetch(url).then(r=>r.blob()).then(b=>new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(b); })); }

  // admin login flow: password kept in memory only
  btnAdminLogin.onclick = ()=>{
    const val = adminPasswordInput.value;
    if(!val){ alert('Masukkan password atau gunakan Deep Clean-up untuk reset.'); return; }
    if(window.__patrol_admin_password === null){ window.__patrol_admin_password = val; state.isAdminLogged=true; adminPasswordInput.value=''; btnAdminLogout.classList.remove('hidden'); btnAdminLogin.classList.add('hidden'); alert('Admin dibuat & login'); renderAreas(); return; }
    if(val === window.__patrol_admin_password){ state.isAdminLogged=true; adminPasswordInput.value=''; btnAdminLogout.classList.remove('hidden'); btnAdminLogin.classList.add('hidden'); alert('Login admin berhasil'); renderAreas(); } else alert('Password salah');
  };
  btnAdminLogout.onclick = ()=>{ state.isAdminLogged=false; btnAdminLogout.classList.add('hidden'); btnAdminLogin.classList.remove('hidden'); renderAreas(); };

  // UI wiring
  btnAddArea.onclick = ()=>{ addArea(areaNameInput.value.trim()||undefined); areaNameInput.value=''; };
  btnModeUser.onclick = ()=>{ state.mode='user'; adminLoginBox.classList.add('hidden'); state.isAdminLogged=false; renderAreas(); };
  btnModeAdmin.onclick = ()=>{ state.mode='admin'; adminLoginBox.classList.remove('hidden'); renderAreas(); };
  btnStartTrack.onclick = startTracking; btnStopTrack.onclick = stopTracking; btnGeneratePDF.onclick = generatePDF;
  tabAreas.onclick = ()=>{ areasSection.classList.remove('hidden'); signatureSection.classList.add('hidden'); };
  tabSignature.onclick = ()=>{ areasSection.classList.add('hidden'); signatureSection.classList.remove('hidden'); };

  // attach modal handlers robustly on DOMContentLoaded
  function safeInit(){
    try{ attachDeepCleanHandlers(); }catch(e){ console.warn('attachDeepCleanHandlers err', e); }
    // button to show modal
    btnDeepClean.onclick = function(){ try{ showDeepClean(); }catch(e){ console.warn(e); } };
    // protective: if modal stuck visible without pointer events, ensure fallback hides it after 20s
    setTimeout(()=>{ if(deepCleanModal && deepCleanModal.classList.contains('visible')){ deepCleanModal.style.pointerEvents = 'auto'; } }, 600);
  }

  // block localStorage writes (defensive)
  try{ if(window.localStorage) Object.defineProperty(window,'localStorage',{ get: ()=>undefined }); }catch(e){}

  // render initial
  renderAreas();

  // run safeInit now and also on DOMContentLoaded (covers both)
  safeInit();
  document.addEventListener('DOMContentLoaded', safeInit);

  // expose debug helper to console
  window.__patrol_state = state;
  window.__patrol_api = { addArea, editAreaName, deleteArea, renderAreas, generatePDF, showDeepClean, hideDeepClean, forceRemoveDeepCleanModal };

  // small helpful functions (reused)
  function addArea(name){ const id = uid('area'); const area = {id, name: name || 'Area '+(state.areas.length+1), photos:[], description:'', createdAt:Date.now()}; state.areas.push(area); renderAreas(); return area; }
  function startTracking(){ if(!navigator.geolocation){ alert('Geolocation tidak tersedia'); return; } trackStatus.innerText='GPS: aktif'; btnStartTrack.classList.add('hidden'); btnStopTrack.classList.remove('hidden'); watchId = navigator.geolocation.watchPosition(pos=>{ coordsEl.innerText = pos.coords.latitude.toFixed(6)+', '+pos.coords.longitude.toFixed(6)+' • '+ new Date(pos.timestamp).toLocaleTimeString(); state.gpsPath.push({lat:pos.coords.latitude, lon:pos.coords.longitude, timestamp:pos.timestamp}); }, err=>{ console.warn(err); trackStatus.innerText='GPS: error/izin'; }, {enableHighAccuracy:true, maximumAge:2000, timeout:8000}); }
  function stopTracking(){ if(typeof watchId !== 'undefined' && watchId !== null && navigator.geolocation) navigator.geolocation.clearWatch(watchId); watchId = null; trackStatus.innerText='GPS: dihentikan'; btnStartTrack.classList.remove('hidden'); btnStopTrack.classList.add('hidden'); }

})();
</script>
</body>
</html>