<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Patroli — with QR Checkpoints</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--primary:#0b69ff;--muted:#6b7280;--danger:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Roboto,Arial;background:var(--bg);color:#111}
  header{background:linear-gradient(90deg,#06204a,#0b1b3a);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  header h1{margin:0;font-size:18px}
  .container{max-width:1150px;margin:16px auto;padding:14px;display:flex;gap:14px;flex-wrap:wrap}
  .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 8px 20px rgba(7,10,25,0.06)}
  .sidebar{width:320px;min-width:260px}
  label{display:block;margin:8px 0 6px;font-weight:600}
  input[type=text], textarea, input[type=password]{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eefb;background:#fff}
  textarea{min-height:80px;resize:vertical;text-align:left}
  .btn{background:var(--primary);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(11,105,255,0.12)}
  .btn.danger{background:var(--danger)}
  .muted{color:var(--muted);font-size:13px}
  .areas{margin-top:12px}
  .area{border-radius:8px;padding:12px;margin-bottom:12px;border:1px solid #e9f0ff;background:linear-gradient(180deg,#fff,#fbfdff)}
  .area-header{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .area-title{font-weight:800;font-size:18px;padding:6px 10px;border-radius:6px;color:#fff}
  .photo-controls{display:flex;gap:8px;align-items:center;margin-top:8px}
  .photos{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .photo-item{width:140px;height:100px;border-radius:8px;overflow:hidden;position:relative;background:#f3f5f8;border:1px solid #e6eefb}
  .photo-item img{width:100%;height:100%;object-fit:cover}
  .photo-meta{font-size:11px;color:#374151;padding:6px;text-align:left}
  .icon-btn{background:rgba(255,255,255,.98);border-radius:6px;padding:6px;border:0;cursor:pointer}
  .signature-canvas{border:1px solid #e6e9ef;border-radius:8px;touch-action:none;background:#fff;display:block}
  .sig-preview{width:160px;height:70px;border:1px solid #e6e9ef;border-radius:6px;overflow:hidden;background:#fff}
  .note{font-size:13px;color:var(--muted);margin-top:8px}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:8px 10px;border-radius:10px;background:#eef2ff;color:var(--primary);cursor:pointer;font-weight:600}
  .qr-list{margin-top:8px}
  .qr-row{display:flex;align-items:center;gap:8px;padding:8px;border-radius:6px;border:1px dashed #e6eefb;margin-bottom:8px}
  .small{font-size:13px;color:#555}
</style>
</head>
<body>
<header>
  <h1>Patroli — QR Checkpoint Ready</h1>
  <div style="display:flex;gap:8px;align-items:center">
    <span id="gpsStatus" class="muted">GPS: belum aktif</span>
    <button id="btnStartGPS" class="btn">Mulai GPS</button>
    <button id="btnStopGPS" class="btn hidden">Stop GPS</button>
    <button id="btnGeneratePDF" class="btn">Generate PDF</button>
    <button id="btnDeep" class="btn danger">Deep Clean</button>
  </div>
</header>

<div class="container">
  <aside class="card sidebar">
    <div class="tabs">
      <div class="tab" id="tabAreas">Area</div>
      <div class="tab" id="tabCheckpoint">Checkpoint (QR)</div>
      <div class="tab" id="tabLokasi">Lokasi</div>
    </div>

    <!-- Area tab (default) -->
    <div id="areaTab">
      <label>Nama Petugas</label><input id="officerName" type="text" placeholder="Nama petugas...">
      <label>Shift</label><input id="shift" type="text" placeholder="Contoh: Malam">
      <label>Tanggal</label><input id="date" type="text" placeholder="YYYY-MM-DD">
      <div style="margin-top:8px" class="muted">Koordinat Terkini: <span id="coords">—</span></div>

      <hr style="margin:10px 0">

      <label>Tambah Area Manual</label>
      <input id="newAreaName" type="text" placeholder="Nama area (manual)...">
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="btnAddArea" class="btn">Tambah Area</button>
        <button id="btnScanAreaQR" class="btn ghost">Scan QR (user camera)</button>
      </div>

      <div style="margin-top:12px" class="note">Jika user memindai QR, nama area otomatis terisi (QR harus dibuat/admin set sebelumnya). User hanya bisa scan via kamera (bukan galeri).</div>
    </div>

    <!-- Checkpoint (QR) tab -->
    <div id="checkpointTab" class="hidden">
      <label>Daftar Checkpoint (Admin)</label>
      <div class="qr-list" id="qrList"></div>

      <label style="margin-top:8px">Buat Checkpoint Baru</label>
      <input id="checkpointName" type="text" placeholder="Nama titik checkpoint...">
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="btnCreateCheckpoint" class="btn">Buat & Salin QR Content</button>
        <button id="btnScanCheckpoint" class="btn ghost">Scan QR (galeri/kamera)</button>
      </div>
      <div class="note" style="margin-top:8px">QR content bisa dicopy lalu dicetak atau gunakan generator QR eksternal. Scanner memanfaatkan BarcodeDetector jika tersedia; admin dapat scan dari galeri atau kamera.</div>
    </div>

    <!-- Lokasi tab -->
    <div id="lokasiTab" class="hidden">
      <label>Input Lokasi (untuk header cover)</label>
      <input id="manualLokasi" type="text" placeholder="Contoh: Blok A - Gedung X">
      <div style="margin-top:8px" class="note">Isi lokasi ini akan tampil di cover PDF (jika GPS kosong atau bila ingin override).</div>
    </div>

    <hr style="margin:12px 0">
    <div class="note">Mode admin/user & akses photo/QR diatur: Admin boleh gunakan galeri; user hanya kamera. Semua data disimpan sementara di memori.</div>
  </aside>

  <main class="card" style="flex:1 1 700px">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <div class="tab" id="tabViewAreas">Daftar Area</div>
      <div class="tab" id="tabSignature">Tanda Tangan</div>
    </div>

    <section id="viewAreas">
      <div id="areasContainer" class="areas"></div>
    </section>

    <section id="viewSignature" class="hidden">
      <label>Nama pada tanda tangan</label>
      <input id="sigName" type="text" placeholder="Nama pada tanda tangan...">
      <div style="margin-top:8px"><canvas id="sigCanvas" class="signature-canvas" width="700" height="140"></canvas></div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button id="btnClearSig" class="btn danger">Hapus</button>
        <button id="btnSaveSig" class="btn">Simpan Tanda Tangan</button>
        <div style="margin-left:12px"><div class="muted">Preview:</div><div id="sigPreview" class="sig-preview"></div></div>
      </div>
    </section>
  </main>
</div>

<script>
/* patrol_app_with_qr.js - single file */
(function(){
  // state (in-memory)
  const state = {
    isAdmin: false,
    adminPassword: window.__patrol_admin_password ?? 'raja123',
    areas: [], // {id,name,createdAt,description,locationOverride,photos: [{id,file,url,desc,lat,lon,ts}]}
    checkpoints: [], // {id,name,contentString}
    gpsPath: [],
    signature: null
  };

  // dom refs
  const $ = s => document.querySelector(s);
  const qAll = s => Array.from(document.querySelectorAll(s));
  const btnStartGPS = $('#btnStartGPS'), btnStopGPS = $('#btnStopGPS'), gpsStatus = $('#gpsStatus'), coordsEl = $('#coords');
  const btnAddArea = $('#btnAddArea'), newAreaName = $('#newAreaName'), areasContainer = $('#areasContainer');
  const tabAreas = $('#tabAreas'), tabCheckpoint = $('#tabCheckpoint'), tabLokasi = $('#tabLokasi');
  const areaTab = $('#areaTab'), checkpointTab = $('#checkpointTab'), lokasiTab = $('#lokasiTab');
  const btnCreateCheckpoint = $('#btnCreateCheckpoint'), checkpointName = $('#checkpointName'), qrList = $('#qrList'), btnScanCheckpoint = $('#btnScanCheckpoint');
  const btnScanAreaQR = $('#btnScanAreaQR'), manualLokasi = $('#manualLokasi');
  const viewAreasTab = $('#tabViewAreas'), viewSignatureTab = $('#tabSignature');
  const viewAreas = $('#viewAreas'), viewSignature = $('#viewSignature');
  const sigCanvas = $('#sigCanvas'), btnClearSig = $('#btnClearSig'), btnSaveSig = $('#btnSaveSig'), sigPreview = $('#sigPreview'), sigName = $('#sigName');
  const btnGeneratePDF = $('#btnGeneratePDF'), btnDeep = $('#btnDeep');

  // helpers
  const uid = (p='id') => p+'-'+Math.random().toString(36).slice(2,9);
  const revoke = url => { try{ URL.revokeObjectURL(url); }catch(e){} };

  function colorForId(id){
    let h=0; for(let i=0;i<id.length;i++) h=(h<<5)-h+id.charCodeAt(i);
    const hue = Math.abs(h)%360;
    return 'hsl('+hue+',70%,40%)';
  }
  function colorForIdRgb(id){
    let h=0; for(let i=0;i<id.length;i++) h=(h<<5)-h+id.charCodeAt(i);
    const hue = Math.abs(h)%360;
    // return rgb
    const rgb = hslToRgb(hue/360,0.7,0.4);
    return rgb;
  }
  function hslToRgb(h,s,l){
    let r,g,b;
    if(s===0){ r=g=b=l; }else{
      const hue2rgb=(p,q,t)=>{ if(t<0) t+=1; if(t>1) t-=1; if(t<1/6) return p+(q-p)*6*t; if(t<1/2) return q; if(t<2/3) return p+(q-p)*(2/3-t)*6; return p; };
      const q = l<0.5? l*(1+s): l+s - l*s;
      const p = 2*l - q;
      r = hue2rgb(p,q,h+1/3); g = hue2rgb(p,q,h); b = hue2rgb(p,q,h-1/3);
    }
    return [Math.round(r*255), Math.round(g*255), Math.round(b*255)];
  }

  // GPS watch
  let watchId = null;
  function startGPS(){
    if(!navigator.geolocation){ alert('Geolocation not supported'); return; }
    btnStartGPS.classList.add('hidden'); btnStopGPS.classList.remove('hidden');
    gpsStatus.textContent='GPS: aktif';
    watchId = navigator.geolocation.watchPosition(pos=>{
      const lat=pos.coords.latitude, lon=pos.coords.longitude, ts=pos.timestamp;
      coordsEl.textContent = lat.toFixed(6)+', '+lon.toFixed(6)+' @ '+ new Date(ts).toLocaleTimeString();
      state.gpsPath.push({lat,lon,timestamp:ts});
    }, err=>{ console.warn(err); gpsStatus.textContent='GPS: error'; }, {enableHighAccuracy:true,maximumAge:2000,timeout:8000});
  }
  function stopGPS(){ if(watchId && navigator.geolocation) navigator.geolocation.clearWatch(watchId); watchId=null; btnStartGPS.classList.remove('hidden'); btnStopGPS.classList.add('hidden'); gpsStatus.textContent='GPS: dihentikan'; }

  // UI: tabs left
  tabAreas.addEventListener('click', ()=>{ areaTab.classList.remove('hidden'); checkpointTab.classList.add('hidden'); lokasiTab.classList.add('hidden'); });
  tabCheckpoint.addEventListener('click', ()=>{ areaTab.classList.add('hidden'); checkpointTab.classList.remove('hidden'); lokasiTab.classList.add('hidden'); });
  tabLokasi.addEventListener('click', ()=>{ areaTab.classList.add('hidden'); checkpointTab.classList.add('hidden'); lokasiTab.classList.remove('hidden'); });

  // view tabs main
  viewAreasTab.addEventListener('click', ()=>{ viewAreas.classList.remove('hidden'); viewSignature.classList.add('hidden'); });
  viewSignatureTab.addEventListener('click', ()=>{ viewAreas.classList.add('hidden'); viewSignature.classList.remove('hidden'); });

  // Area creation
  $('#btnAddArea').addEventListener('click', ()=>{ const v = newAreaName.value.trim(); addArea(v||undefined); newAreaName.value=''; });

  function addArea(name){
    const id = uid('area');
    const a = {id, name: name || ('Area '+(state.areas.length+1)), createdAt: Date.now(), description:'', locationOverride:'', photos:[]};
    state.areas.push(a);
    renderAreas();
  }

  // render areas in main view
  function renderAreas(){
    areasContainer.innerHTML = '';
    state.areas.forEach(area=>{
      const wrapper = document.createElement('div'); wrapper.className='area';
      // header
      const h = document.createElement('div'); h.className='area-header';
      const title = document.createElement('div'); title.className='area-title'; title.textContent = area.name;
      title.style.background = colorForId(area.id);
      h.appendChild(title);
      const actions = document.createElement('div');
      const editBtn = document.createElement('button'); editBtn.className='icon-btn'; editBtn.innerHTML='<i class="fa fa-pen"></i>'; editBtn.title='Edit nama area';
      editBtn.onclick = ()=>{ const nv = prompt('Edit nama area:', area.name); if(nv!==null){ area.name = nv; renderAreas(); } };
      const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.innerHTML='<i class="fa fa-trash"></i>'; delBtn.title='Hapus area';
      delBtn.onclick = ()=>{ if(confirm('Hapus area & semua fotonya?')){ area.photos.forEach(p=>revoke(p.url)); state.areas = state.areas.filter(x=>x.id!==area.id); renderAreas(); } };
      const qrBtn = document.createElement('button'); qrBtn.className='icon-btn'; qrBtn.innerHTML='<i class="fa fa-qrcode"></i>'; qrBtn.title='Scan QR to fill this area (camera only)';
      qrBtn.onclick = async ()=>{ // user scan to fill
        try {
          const result = await scanQrForUser(); if(result){ area.name = result; renderAreas(); alert('Area name auto-filled from QR: '+result); }
        } catch(e){ alert('Scan QR gagal: '+ (e.message||e)); }
      };
      actions.appendChild(editBtn); actions.appendChild(qrBtn); actions.appendChild(delBtn);
      h.appendChild(actions);
      wrapper.appendChild(h);

      // upload controls
      const pc = document.createElement('div'); pc.className='photo-controls';
      if(state.isAdmin){
        const galBtn = document.createElement('button'); galBtn.className='btn ghost'; galBtn.textContent='Pilih dari Galeri (multiple)';
        galBtn.onclick = async ()=>{ const r = await createFileInput({allowGallery:true,multiple:true}); await handleFilesSelected(area.id,r.files,r.pos); };
        const camBtn = document.createElement('button'); camBtn.className='btn ghost'; camBtn.textContent='Ambil Foto (kamera)';
        camBtn.onclick = async ()=>{ const r = await createFileInput({allowGallery:false,multiple:false}); await handleFilesSelected(area.id,r.files,r.pos); };
        pc.appendChild(galBtn); pc.appendChild(camBtn);
      } else {
        const camBtn = document.createElement('button'); camBtn.className='btn ghost'; camBtn.textContent='Ambil Foto (kamera)';
        camBtn.onclick = async ()=>{ const r = await createFileInput({allowGallery:false,multiple:false}); await handleFilesSelected(area.id,r.files,r.pos); };
        pc.appendChild(camBtn);
      }
      wrapper.appendChild(pc);

      // photo thumbnails + meta
      const photosWrap = document.createElement('div'); photosWrap.className='photos';
      area.photos.forEach(p=>{
        const col = document.createElement('div'); col.style.width='170px';
        const photoItem = document.createElement('div'); photoItem.className='photo-item';
        const img = document.createElement('img'); img.src = p.url; photoItem.appendChild(img);
        const actionWrap = document.createElement('div'); actionWrap.style.position='absolute'; actionWrap.style.left='6px'; actionWrap.style.bottom='6px'; actionWrap.style.display='flex'; actionWrap.style.gap='6px';
        const del = document.createElement('button'); del.className='icon-btn'; del.innerHTML='<i class="fa fa-trash" style="color:#b91c1c"></i>';
        del.onclick = ()=>{ if(confirm('Hapus foto?')){ area.photos = area.photos.filter(pp=>pp.id!==p.id); revoke(p.url); renderAreas(); } };
        const edit = document.createElement('button'); edit.className='icon-btn'; edit.innerHTML='<i class="fa fa-pen" style="color:#0b1228"></i>';
        edit.onclick = ()=>{ const v = prompt('Deskripsi (tanpa batas):', p.desc||''); if(v!==null){ p.desc = v; renderAreas(); } };
        actionWrap.appendChild(del); actionWrap.appendChild(edit);
        photoItem.appendChild(actionWrap);

        const meta = document.createElement('div'); meta.className='photo-meta';
        meta.innerHTML = `<div style="font-weight:700">${p.desc || '(klik pensil untuk deskripsi)'}</div>
          <div style="font-size:11px;color:#555">${p.lat? p.lat.toFixed(6): '-'}, ${p.lon? p.lon.toFixed(6): '-'}<br>${p.ts? new Date(p.ts).toLocaleString(): ''}</div>`;
        col.appendChild(photoItem); col.appendChild(meta);
        photosWrap.appendChild(col);
      });
      wrapper.appendChild(photosWrap);

      // area description save
      const ta = document.createElement('textarea'); ta.value = area.description || ''; ta.placeholder='Deskripsi area...'; ta.oninput = ()=> area.description = ta.value;
      const saveBtn = document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='Simpan Deskripsi Area'; saveBtn.onclick = ()=> alert('Deskripsi area disimpan');
      wrapper.appendChild(ta); wrapper.appendChild(saveBtn);

      areasContainer.appendChild(wrapper);
    });
  }

  // file input helper: returns {files, pos}
  function createFileInput(opts){
    return new Promise(resolve=>{
      // sample GPS position before opening dialog (best-effort)
      function getPos(cb){
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(p=>cb({lat:p.coords.latitude,lon:p.coords.longitude,ts:p.timestamp}), ()=>cb(null), {enableHighAccuracy:true,timeout:4000});
        } else cb(null);
      }
      getPos(function(pos){
        const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*'; if(opts.multiple) inp.multiple=true; if(!opts.allowGallery) inp.setAttribute('capture','environment');
        inp.style.display='none'; document.body.appendChild(inp);
        inp.addEventListener('change', e=>{ const files = Array.from(e.target.files || []); try{ document.body.removeChild(inp);}catch(e){}; resolve({files,pos}); });
        inp.click();
        setTimeout(()=>{ try{ if(document.body.contains(inp)) document.body.removeChild(inp);}catch(e){}; resolve({files:[],pos}); },30000);
      });
    });
  }

  async function handleFilesSelected(areaId, files, pos){
    const area = state.areas.find(a=>a.id===areaId); if(!area) return;
    for(const f of files){
      const pid = uid('photo');
      const url = URL.createObjectURL(f);
      let lat=null, lon=null, ts=null;
      if(pos){ lat = pos.lat; lon = pos.lon; ts = pos.ts; }
      else if(state.gpsPath.length){ const g = state.gpsPath[state.gpsPath.length-1]; lat=g.lat; lon=g.lon; ts=g.timestamp; }
      area.photos.push({id:pid,file:f,url,desc:'',lat,lon,ts});
    }
    renderAreas();
  }

  // QR checkpoints: create entry (admin)
  btnCreateCheckpoint.addEventListener('click', ()=>{
    const name = checkpointName.value.trim(); if(!name){ alert('Masukkan nama checkpoint'); return; }
    const id = uid('cp'); const content = JSON.stringify({type:'patrol-checkpoint', id, name});
    state.checkpoints.push({id, name, content});
    checkpointName.value='';
    renderCheckpointList();
    // copy content
    navigator.clipboard?.writeText(content).then(()=> alert('Checkpoint dibuat & QR content disalin ke clipboard. Gunakan generator QR eksternal untuk membuat gambar QR.'), ()=> alert('Checkpoint dibuat. Salin QR content: '+content));
  });

  function renderCheckpointList(){
    qrList.innerHTML = '';
    state.checkpoints.forEach(cp=>{
      const row = document.createElement('div'); row.className='qr-row';
      row.innerHTML = `<div style="flex:1"><strong>${cp.name}</strong><div class="small">${cp.content}</div></div>`;
      const copyBtn = document.createElement('button'); copyBtn.className='btn ghost'; copyBtn.textContent='Copy';
      copyBtn.onclick = ()=> { navigator.clipboard?.writeText(cp.content).then(()=>alert('QR content disalin'), ()=>alert('Salin manual: '+cp.content)); };
      const del = document.createElement('button'); del.className='btn danger'; del.textContent='Hapus'; del.onclick = ()=>{ if(confirm('Hapus checkpoint?')){ state.checkpoints = state.checkpoints.filter(x=>x.id!==cp.id); renderCheckpointList(); } };
      row.appendChild(copyBtn); row.appendChild(del);
      qrList.appendChild(row);
    });
  }

  // QR scanning helpers
  async function scanUsingBarcodeDetectorFromCamera(allowGallery){
    // try BarcodeDetector API
    if(window.BarcodeDetector){
      const formats = ['qr_code'];
      const detector = new BarcodeDetector({formats});
      // open capture via input and convert to ImageBitmap
      return new Promise((resolve, reject)=>{
        const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*'; if(!allowGallery) inp.setAttribute('capture','environment');
        inp.style.display='none'; document.body.appendChild(inp);
        inp.addEventListener('change', async (e)=>{
          const file = e.target.files && e.target.files[0];
          try{ if(!file){ document.body.removeChild(inp); resolve(null); return; }
            const imageBitmap = await createImageBitmap(file);
            const results = await detector.detect(imageBitmap);
            document.body.removeChild(inp);
            if(results && results.length) resolve(results[0].rawValue);
            else resolve(null);
          } catch(err){ document.body.removeChild(inp); reject(err); }
        });
        inp.click();
        setTimeout(()=>{ try{ if(document.body.contains(inp)) document.body.removeChild(inp);}catch(e){}; reject(new Error('Scan timeout or cancelled')); }, 30000);
      });
    } else {
      // fallback: no BarcodeDetector — use file input and ask user to paste content
      return new Promise((resolve)=>{
        const manual = confirm('Scanner QR tidak tersedia di browser ini. Mau paste content QR secara manual? (Cancel = batal)');
        if(!manual){ resolve(null); return; }
        const val = prompt('Paste QR content (text) di sini:');
        resolve(val || null);
      });
    }
  }

  // specialized function for user QR scan (camera-only)
  async function scanQrForUser(){
    try{
      const res = await scanUsingBarcodeDetectorFromCamera(false); // allowGallery=false => camera-only
      if(!res) throw new Error('Tidak ada QR terdeteksi atau dibatalkan');
      // parse if it's our checkpoint content format
      try{
        const parsed = JSON.parse(res);
        if(parsed && parsed.type==='patrol-checkpoint' && parsed.name) return parsed.name;
      }catch(e){}
      // otherwise return raw text
      return res;
    } catch(e){ throw e; }
  }

  // admin scan (camera or gallery)
  $('#btnScanCheckpoint').addEventListener('click', async ()=>{
    try{
      const res = await scanUsingBarcodeDetectorFromCamera(true);
      if(!res){ alert('QR tidak terdeteksi / dibatalkan'); return; }
      try{ const parsed = JSON.parse(res); if(parsed && parsed.type==='patrol-checkpoint'){ alert('QR checkpoint: '+parsed.name); } else alert('QR content: '+res); }catch(e){ alert('QR content (raw): '+res); }
    } catch(err){ alert('Scan gagal: '+ err.message); }
  });

  // area-level scan button bound earlier uses scanQrForUser()

  $('#btnScanAreaQR').addEventListener('click', async ()=>{
    try{
      const name = await scanQrForUser();
      if(name){ newAreaName.value = name; alert('Nama area terisi otomatis: '+name); }
    } catch(e){ alert('Scan gagal: '+ (e.message||e)); }
  });

  // signature canvas
  const ctx = sigCanvas.getContext('2d'); let drawing=false, last=null;
  function pos(e){ const r = sigCanvas.getBoundingClientRect(); return {x: (e.touches?e.touches[0].clientX:e.clientX)-r.left, y: (e.touches?e.touches[0].clientY:e.clientY)-r.top}; }
  function sDown(e){ drawing=true; last=pos(e); document.body.style.overflow='hidden'; e.preventDefault(); }
  function sMove(e){ if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.lineCap='round'; ctx.lineWidth=2.6; ctx.strokeStyle='#111'; ctx.stroke(); last=p; e.preventDefault(); }
  function sUp(e){ drawing=false; last=null; document.body.style.overflow=''; }
  sigCanvas.addEventListener('mousedown', sDown); sigCanvas.addEventListener('mousemove', sMove); sigCanvas.addEventListener('mouseup', sUp);
  sigCanvas.addEventListener('touchstart', sDown, {passive:false}); sigCanvas.addEventListener('touchmove', sMove, {passive:false}); sigCanvas.addEventListener('touchend', sUp);
  btnClearSig.addEventListener('click', ()=>{ ctx.clearRect(0,0,sigCanvas.width,sigCanvas.height); state.signature=null; sigPreview.innerHTML=''; });
  btnSaveSig.addEventListener('click', ()=>{ const data = sigCanvas.toDataURL('image/png'); state.signature = data; sigPreview.innerHTML = '<img src="'+data+'" style="width:160px;height:70px;object-fit:contain">'; alert('Tanda tangan tersimpan'); });

  // generate PDF (cover full page with table header, lokasi, area sections, photos large, coords, signature)
  $('#btnGeneratePDF').addEventListener('click', async ()=>{
    try{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'mm', format:'a4'});
      const officer = ($('#officerName').value || 'Petugas');
      const shift = ($('#shift').value || '');
      const tanggal = ($('#date').value || (new Date()).toISOString().slice(0,10));
      const lokasiHeader = ($('#manualLokasi').value || state.gpsPath.length? `${state.gpsPath[state.gpsPath.length-1].lat.toFixed(6)},${state.gpsPath[state.gpsPath.length-1].lon.toFixed(6)}` : '-') || '-';
      const waktu = new Date().toLocaleTimeString();

      // Cover page: full page header title
      // Title bar top
      doc.setFillColor(200, 222, 249);
      doc.rect(0,0,210,35,'F');
      doc.setFontSize(22); doc.setTextColor(10,10,10); doc.text('PETUGAS PATROLI', 105, 22, {align:'center'});

      // Header table left: labels and values
      const leftX = 10, leftY = 45, colW = 95;
      doc.setDrawColor(0);
      // draw table grid with 5 rows
      const rows = ['NAMA','Hari/Tanggal','Shift','Jam','Lokasi'];
      const values = [officer, tanggal, shift, waktu, ($('#manualLokasi').value || lokasiHeader)];
      const rowH = 10;
      // left column label background grey
      doc.setFillColor(230,230,230);
      doc.rect(leftX, leftY, 40, rowH*rows.length, 'F');
      // draw rows
      for(let i=0;i<rows.length;i++){
        const y = leftY + i*rowH;
        // label cell (left)
        doc.setFontSize(10); doc.setTextColor(0,0,0);
        doc.text(rows[i], leftX+2, y+7);
        // value cell border and text
        doc.rect(leftX, y, colW, rowH);
        doc.text(values[i].toString(), leftX+42, y+7);
      }
      // right area for profile photo placeholder big
      doc.setDrawColor(0);
      doc.rect(110, leftY, 90, rowH*3 + 10); // big box for photo
      // if there is available photo (first area first photo) embed
      let profileAdded = false;
      if(state.areas.length && state.areas[0].photos.length){
        try{
          const durl = await fetchAsDataUrl(state.areas[0].photos[0].url);
          const props = doc.getImageProperties(durl);
          const w = 88; const h = (props.height/props.width)*w;
          doc.addImage(durl, 'JPEG', 112, leftY+2, w, Math.min(h, 80));
          profileAdded = true;
        } catch(e){ console.warn(e); }
      }
      // ensure cover is alone
      doc.addPage();

      // content per area
      for(const area of state.areas){
        // area title full width with background color
        const rgb = colorForIdRgb(area.id);
        doc.setFillColor(rgb[0],rgb[1],rgb[2]);
        doc.rect(10,10,190,10,'F');
        doc.setTextColor(255,255,255); doc.setFontSize(14); doc.text(area.name, 15, 17);
        doc.setTextColor(0,0,0); let y = 28;
        // area-level description
        if(area.description && area.description.trim().length){
          const lines = doc.splitTextToSize(area.description, 180);
          doc.setFontSize(10); doc.text(lines, 12, y);
          y += lines.length*5 + 6;
        }
        // each photo gets a big block
        for(const p of area.photos){
          // ensure fit: target width 160mm
          try{
            const durl = await fetchAsDataUrl(p.url);
            const props = doc.getImageProperties(durl);
            const targetW = 160; const targetH = (props.height/props.width)*targetW;
            if(y + targetH + 30 > 290){ doc.addPage(); y = 20; }
            doc.addImage(durl, 'JPEG', 14, y, targetW, targetH);
            y += targetH + 6;
            // description under photo (left-aligned)
            if(p.desc && p.desc.trim().length){
              doc.setFontSize(10); const lines = doc.splitTextToSize(p.desc, 180); doc.text(lines, 14, y); y += lines.length*5 + 4;
            }
            // coords
            const coordLine = (p.lat && p.lon) ? (`Koordinat: ${p.lat.toFixed(6)}, ${p.lon.toFixed(6)} — ${p.ts? new Date(p.ts).toLocaleString() : ''}`) : 'Koordinat: -';
            doc.setFontSize(9); doc.text(coordLine, 14, y); y += 12;
          } catch(e){ console.warn('photo add fail', e); }
        }
        doc.addPage();
      }

      // signature page
      doc.setFontSize(12); doc.text('Tanda Tangan Petugas', 14, 26);
      if(state.signature){
        try{ doc.addImage(state.signature, 'PNG', 14, 34, 120, 40); } catch(e){ console.warn('sig add', e); }
      }
      doc.setLineWidth(0.7);
      doc.line(14, 86, 14+120, 86);
      doc.setFontSize(11); doc.text($('#officerName').value || 'Petugas', 14, 96);
      doc.setFontSize(9); doc.text('Tanda tangan sudah otomatis terverifikasi dan tervalidasi by system', 14, 106);

      // GPS summary
      doc.setFontSize(9); doc.text('GPS path (latest 10):', 14, 116);
      const gpsSample = state.gpsPath.slice(-10).map(g => `${g.lat?.toFixed(6)||''},${g.lon?.toFixed(6)||''} @ ${new Date(g.timestamp||Date.now()).toLocaleString()}`);
      doc.setFontSize(8); doc.text(doc.splitTextToSize(gpsSample.join('\n'), 180), 14, 122);

      // finalize download
      const ab = doc.output('arraybuffer'); const blob = new Blob([ab], {type:'application/pdf'}); const url = URL.createObjectURL(blob);
      const aEl = document.createElement('a'); aEl.href = url; aEl.download = 'laporan_patroli_'+(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'_')+'.pdf';
      document.body.appendChild(aEl); aEl.click();
      setTimeout(()=>{ try{ document.body.removeChild(aEl); URL.revokeObjectURL(url);}catch(e){} },1500);

    } catch(err){ console.error(err); alert('Generate PDF gagal: '+ (err.message || err)); }
  });

  // helper: fetch objectURL -> dataURL
  async function fetchAsDataUrl(url){
    const resp = await fetch(url);
    const blob = await resp.blob();
    return await new Promise((res,rej)=>{ const fr = new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(blob); });
  }

  // scan helper used for admin scan as well: reuse scanUsingBarcodeDetectorFromCamera defined here
  async function scanUsingBarcodeDetectorFromCamera(allowGallery){
    if(window.BarcodeDetector){
      const detector = new BarcodeDetector({formats:['qr_code']});
      return new Promise((resolve,reject)=>{
        const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*'; if(!allowGallery) inp.setAttribute('capture','environment'); inp.style.display='none'; document.body.appendChild(inp);
        inp.addEventListener('change', async (e)=>{
          const file = e.target.files && e.target.files[0];
          try{ if(!file){ document.body.removeChild(inp); resolve(null); return; }
            const bitmap = await createImageBitmap(file);
            const results = await detector.detect(bitmap);
            document.body.removeChild(inp);
            if(results && results.length) resolve(results[0].rawValue); else resolve(null);
          } catch(err){ document.body.removeChild(inp); reject(err); }
        });
        inp.click();
        setTimeout(()=>{ try{ if(document.body.contains(inp)) document.body.removeChild(inp);}catch(e){}; reject(new Error('Scan timeout / canceled')); },30000);
      });
    } else {
      // fallback manual paste
      return new Promise((resolve)=>{ const manual = confirm('Scanner tidak tersedia. Mau paste QR content manual?'); if(!manual) return resolve(null); const v = prompt('Paste QR content:'); resolve(v||null); });
    }
  }

  // admin scan binder
  $('#btnScanCheckpoint').addEventListener('click', async ()=>{
    try{
      const content = await scanUsingBarcodeDetectorFromCamera(true);
      if(!content){ alert('QR tidak deteksi atau dibatalkan'); return; }
      try{
        const parsed = JSON.parse(content);
        if(parsed && parsed.type==='patrol-checkpoint'){ alert('Checkpoint: '+parsed.name); }
        else alert('QR content: '+content);
      }catch(e){ alert('QR content: '+content); }
    } catch(err){ alert('Scan gagal: '+ (err.message||err)); }
  });

  // For user button qr scan (top)
  $('#btnScanAreaQR').addEventListener('click', async ()=>{
    try{
      const content = await scanUsingBarcodeDetectorFromCamera(false);
      if(!content){ alert('Tidak ada QR / dibatalkan'); return; }
      let nameVal = null;
      try{ const parsed = JSON.parse(content); if(parsed && parsed.type==='patrol-checkpoint') nameVal = parsed.name; }catch(e){}
      if(!nameVal) nameVal = content;
      newAreaName.value = nameVal; alert('Nama area otomatis terisi: '+ nameVal);
    } catch(err){ alert('Scan failed: '+ (err.message||err)); }
  });

  // Admin create list render (bind btnScanCheckpoint id)
  $('#btnCreateCheckpoint').addEventListener('click', ()=>{
    const name = $('#checkpointName').value.trim(); if(!name){ alert('Masukkan nama checkpoint'); return; }
    const id = uid('cp'); const content = JSON.stringify({type:'patrol-checkpoint', id, name});
    state.checkpoints.push({id,name,content});
    $('#checkpointName').value='';
    renderCheckpointList();
    try{ navigator.clipboard.writeText(content).then(()=> alert('Checkpoint dibuat & QR content disalin')); }catch(e){ alert('Checkpoint dibuat. Content: '+content); }
  });

  function renderCheckpointList(){
    qrList.innerHTML = '';
    state.checkpoints.forEach(cp=>{
      const row = document.createElement('div'); row.className='qr-row';
      row.innerHTML = `<div style="flex:1"><strong>${cp.name}</strong><div class="small">${cp.content}</div></div>`;
      const copyBtn = document.createElement('button'); copyBtn.className='btn ghost'; copyBtn.textContent='Copy';
      copyBtn.onclick = ()=>{ navigator.clipboard.writeText(cp.content).then(()=>alert('disalin'), ()=>alert('Copy failed. Content: '+cp.content)); };
      const del = document.createElement('button'); del.className='btn danger'; del.textContent='Hapus'; del.onclick = ()=>{ if(confirm('Hapus checkpoint?')){ state.checkpoints = state.checkpoints.filter(x=>x.id!==cp.id); renderCheckpointList(); } };
      row.appendChild(copyBtn); row.appendChild(del); qrList.appendChild(row);
    });
  }

  // deep clean
  btnDeep.addEventListener('click', ()=>{ if(confirm('Deep Clean: hapus semua data & password?')){ state.areas.forEach(a=>a.photos.forEach(p=>revoke(p.url))); state.areas=[]; state.checkpoints=[]; state.gpsPath=[]; state.signature=null; window.__patrol_admin_password = null; renderAreas(); renderCheckpointList(); alert('Deep clean done'); } });

  // initial bind GPS start/stop
  btnStartGPS.addEventListener('click', startGPS);
  btnStopGPS.addEventListener('click', stopGPS);

  // expose helpers for debug & initial small helpers
  window.__patrol_state = state;
  window.__patrol_api = { addArea, renderAreas, createFileInput: createFileInput, scanUsingBarcodeDetectorFromCamera, scanQrForUser: async ()=>await scanUsingBarcodeDetectorFromCamera(false) };

  // render initial
  renderAreas();
  renderCheckpointList();

})();
</script>
</body>
</html>