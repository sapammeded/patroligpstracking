<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Patroli GPS — Final</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --primary:#0b69ff; --muted:#6b7280;
    --accent:#0f172a; --danger:#ef4444; --success:#10b981;
    font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  }
  *{box-sizing:border-box}
  body{margin:0;padding:0;background:var(--bg);color:#111}
  header{background:linear-gradient(90deg,#0b1228,#082046);color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
  header h1{font-size:18px;margin:0;font-weight:600}
  .container{padding:18px;max-width:1200px;margin:18px auto;display:flex;gap:16px;flex-wrap:wrap}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 24px rgba(7,10,25,0.06)}
  .sidebar{width:300px;min-width:260px}
  .muted{color:var(--muted);font-size:13px}
  label{display:block;margin:10px 0 6px;font-weight:600}
  input[type=text], input[type=password], textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e9ef;font-size:14px;background:#fbfdff}
  textarea{min-height:90px;resize:vertical;text-align:left}
  .topbar-controls{display:flex;gap:10px;align-items:center}
  .btn{background:var(--primary);color:#fff;border:0;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(11,105,255,0.12)}
  .btn.danger{background:var(--danger)}
  .row{display:flex;gap:12px;align-items:flex-start}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:8px 10px;border-radius:10px;background:#eef2ff;color:var(--primary);cursor:pointer;font-weight:600}
  .hidden{display:none}
  .areas{margin-top:12px}
  .area{border-radius:10px;padding:12px;margin-bottom:12px;border:1px solid #eef2f6;background:linear-gradient(180deg,#fff,#fbfdff)}
  .area-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
  .area-title{font-size:15px;font-weight:700}
  .area-actions{display:flex;gap:8px;align-items:center}
  .photo-controls{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .photos{display:flex;gap:8px;flex-wrap:wrap}
  .photo-item{width:120px;height:90px;border-radius:8px;overflow:hidden;position:relative;background:#f3f4f6;border:1px solid #e7eefb}
  .photo-item img{width:100%;height:100%;object-fit:cover;display:block}
  .photo-item .actions{position:absolute;left:6px;bottom:6px;display:flex;gap:6px}
  .icon-btn{background:rgba(255,255,255,0.95);border-radius:6px;padding:6px;font-size:12px;border:0;cursor:pointer}
  .icon-pencil{color:#0b1228}
  .icon-trash{color:#b91c1c}
  .icon-save{color:#0b69ff}
  .desc-row{margin-top:8px}
  .small{font-size:13px;color:#374151}
  .signature-canvas{border:1px solid #e6e9ef;border-radius:8px;touch-action:none;background:#fff;display:block}
  .sig-thumb{width:140px;height:60px;border:1px solid #e6e9ef;border-radius:6px;overflow:hidden;background:#fff;display:inline-block}
  .note{font-size:13px;color:var(--muted);margin-top:8px}
  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(6,8,20,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{background:#fff;padding:18px;border-radius:10px;max-width:420px;width:92%}
  .modal h3{margin:0 0 8px}
  .muted-sm{font-size:13px;color:#6b7280}
  /* responsive */
  @media(max-width:880px){
    .container{padding:12px}
    .sidebar{width:100%}
    .card[role=main]{width:100%}
  }
</style>
</head>
<body>
<header>
  <h1>Patroli GPS — Final</h1>
  <div class="topbar-controls">
    <span id="trackStatus" class="muted">GPS: belum aktif</span>
    <button id="btnStartTrack" class="btn">Mulai Tracking</button>
    <button id="btnStopTrack" class="btn hidden">Stop</button>
    <button id="btnGeneratePDF" class="btn">Generate PDF</button>
    <button id="btnDeepClean" class="btn danger">Deep Clean-up</button>
  </div>
</header>

<div class="container">
  <aside class="card sidebar" role="complementary">
    <div>
      <label>Mode</label>
      <div style="display:flex;gap:8px">
        <button id="btnModeUser" class="btn ghost">User Biasa</button>
        <button id="btnModeAdmin" class="btn ghost">Admin</button>
      </div>

      <div id="adminLoginBox" style="margin-top:12px;" class="hidden">
        <label>Masuk Admin</label>
        <input id="adminPassword" type="password" placeholder="Masukkan password admin...">
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="btnAdminLogin" class="btn">Login</button>
          <button id="btnAdminLogout" class="btn danger hidden">Logout</button>
        </div>
        <div class="note">Password disimpan aman di memori — tidak ditampilkan di layar. Untuk membuat ulang akses, gunakan Deep Clean-up.</div>
      </div>
    </div>

    <hr style="margin:12px 0">

    <div>
      <label>Petugas (nama)</label>
      <input id="officerName" type="text" placeholder="Nama petugas...">
      <label>Shift</label>
      <input id="shift" type="text" placeholder="Shift (contoh: Malam)">
      <label>Tanggal</label>
      <input id="tanggal" type="text" placeholder="YYYY-MM-DD">
      <div style="margin-top:10px" class="muted">GPS coords terkini:</div>
      <div id="coords" class="small">—</div>
    </div>

    <hr style="margin:12px 0">

    <div>
      <label>Tambah Area Patroli</label>
      <input id="areaName" type="text" placeholder="Nama area...">
      <div style="margin-top:8px">
        <button id="btnAddArea" class="btn">Tambah Area</button>
      </div>
    </div>

    <div style="margin-top:12px" class="note">Semua data hanya tersimpan sementara di aplikasi (memori). Deep Clean-up akan menghapus semua data & password.</div>
  </aside>

  <main class="card" role="main" style="flex:1 1 720px">
    <div class="tabs">
      <div class="tab" id="tabAreas">Daftar Area</div>
      <div class="tab" id="tabSignature">Tanda Tangan</div>
    </div>

    <section id="areasSection">
      <div style="margin-bottom:10px" class="note">Foto untuk tiap area <b>unlimited</b>. User biasa hanya dapat ambil foto via <b>kamera</b>. Admin dapat pilih kamera atau galeri.</div>
      <div class="areas" id="areas"></div>
    </section>

    <section id="signatureSection" class="hidden">
      <label>Nama pada tanda tangan</label>
      <input id="sigName" type="text" placeholder="Nama lengkap...">
      <label style="margin-top:8px">Tanda tangan (scroll akan dinonaktifkan saat menulis)</label>
      <div style="position:relative;margin-top:8px">
        <canvas id="sigCanvas" class="signature-canvas" width="720" height="140"></canvas>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <button id="btnClearSig" class="btn danger">Hapus</button>
        <button id="btnSaveSig" class="btn">Simpan Tanda Tangan</button>
        <div style="margin-left:16px">
          <div class="muted-sm">Preview:</div>
          <div id="sigPreview" class="sig-thumb"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Deep clean modal -->
<div id="deepCleanModal" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal">
    <h3>DEEP CLEAN-UP</h3>
    <p class="muted-sm">Hapus SEMUA DATA termasuk: Semua area patroli, semua foto, logo, tanda tangan, password akses. Aplikasi akan kembali seperti baru!</p>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button id="btnCancelDeep" class="btn ghost">Batal</button>
      <button id="btnConfirmDeep" class="btn danger">OK — Hapus Semua</button>
    </div>
  </div>
</div>

<template id="areaTemplate">
  <div class="area">
    <div class="area-header">
      <div style="display:flex;align-items:center;gap:8px">
        <div class="area-title"></div>
        <div class="muted small area-created"></div>
      </div>
      <div class="area-actions">
        <button class="icon-btn" title="Edit nama area"><i class="fa fa-pen icon-pencil"></i></button>
        <button class="icon-btn" title="Hapus area"><i class="fa fa-trash icon-trash"></i></button>
      </div>
    </div>

    <div class="photo-controls">
      <div class="photo-upload-box"></div>
      <div class="muted small">Jumlah foto: <span class="photo-count">0</span></div>
    </div>

    <div class="photos"></div>

    <div class="desc-row">
      <label>Deskripsi Area (rata kiri)</label>
      <textarea class="area-desc" placeholder="Isi deskripsi area..."></textarea>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="btn btn-save-desc icon-save"><i class="fa fa-save"></i> Simpan Deskripsi</button>
      </div>
    </div>
  </div>
</template>

<script>
/* ===== Patrol app final ===== */
(function(){
  // in-memory admin password (not exposed). default set once here.
  // Note: not printed on UI.
  window.__patrol_admin_password = window.__patrol_admin_password || 'raja123';

  const state = {
    mode: 'user',
    isAdminLogged: false,
    areas: [],
    gpsPath: [],
    signatureDataUrl: null
  };

  // helpers
  const uid = (p='id') => p+'-'+Math.random().toString(36).slice(2,9);
  const qs = (s, el=document) => el.querySelector(s);
  const qsa = (s, el=document) => Array.from((el||document).querySelectorAll(s));
  const revoke = url => { try{ URL.revokeObjectURL(url);}catch(e){} };

  // dom
  const areasEl = qs('#areas');
  const tpl = qs('#areaTemplate').content;
  const coordsEl = qs('#coords');
  const trackStatus = qs('#trackStatus');
  const btnStartTrack = qs('#btnStartTrack');
  const btnStopTrack = qs('#btnStopTrack');
  const btnAddArea = qs('#btnAddArea');
  const areaNameInput = qs('#areaName');
  const btnModeUser = qs('#btnModeUser');
  const btnModeAdmin = qs('#btnModeAdmin');
  const adminLoginBox = qs('#adminLoginBox');
  const btnAdminLogin = qs('#btnAdminLogin');
  const btnAdminLogout = qs('#btnAdminLogout');
  const adminPasswordInput = qs('#adminPassword');
  const officerName = qs('#officerName');
  const shiftInput = qs('#shift');
  const tanggalInput = qs('#tanggal');
  const btnGeneratePDF = qs('#btnGeneratePDF');
  const btnDeepClean = qs('#btnDeepClean');
  const deepCleanModal = qs('#deepCleanModal');
  const btnCancelDeep = qs('#btnCancelDeep');
  const btnConfirmDeep = qs('#btnConfirmDeep');

  const tabAreas = qs('#tabAreas');
  const tabSignature = qs('#tabSignature');
  const areasSection = qs('#areasSection');
  const signatureSection = qs('#signatureSection');

  const sigCanvas = qs('#sigCanvas');
  const sigName = qs('#sigName');
  const btnClearSig = qs('#btnClearSig');
  const btnSaveSig = qs('#btnSaveSig');
  const sigPreview = qs('#sigPreview');

  // camera input generator
  function createFileInput(opts){
    // opts: {allowGallery:boolean, multiple:boolean, areaId}
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    if (opts.multiple) input.multiple = true;
    if (!opts.allowGallery) input.setAttribute('capture','environment'); // camera-only
    input.dataset.areaId = opts.areaId || '';
    input.style.display = 'none';
    document.body.appendChild(input);
    input.addEventListener('change', e => {
      const files = Array.from(e.target.files || []);
      if (opts.onChange) opts.onChange(files);
      setTimeout(()=>{ try{ document.body.removeChild(input);}catch(e){} }, 400);
    });
    return input;
  }

  // add/edit/delete area
  function addArea(name){
    const id = uid('area');
    const area = { id, name: name || 'Area '+(state.areas.length+1), photos: [], description:'', createdAt: Date.now() };
    state.areas.push(area);
    renderAreas();
    return area;
  }
  function editAreaName(areaId){
    const area = state.areas.find(a=>a.id===areaId);
    if(!area) return;
    const newName = prompt('Edit nama area:', area.name);
    if(newName !== null) { area.name = newName; renderAreas(); }
  }
  function deleteArea(areaId){
    if(!confirm('Hapus area ini beserta semua foto yang ada?')) return;
    const idx = state.areas.findIndex(a=>a.id===areaId);
    if(idx>=0){
      state.areas[idx].photos.forEach(p=>revoke(p.url));
      state.areas.splice(idx,1);
      renderAreas();
    }
  }

  // handle selected files
  function handleFilesSelected(areaId, files){
    const area = state.areas.find(a=>a.id===areaId);
    if(!area) return;
    files.forEach(file=>{
      const pid = uid('photo');
      const url = URL.createObjectURL(file);
      area.photos.push({id:pid, file, url, desc:''});
    });
    renderAreas();
  }

  // render areas
  function renderAreas(){
    areasEl.innerHTML = '';
    state.areas.forEach(area=>{
      const node = tpl.cloneNode(true);
      const el = node.querySelector('.area');
      qs('.area-title', el).innerText = area.name;
      qs('.area-created', el).innerText = ' • '+ new Date(area.createdAt).toLocaleString();

      // actions
      const editBtn = qs('.icon-btn', el);
      const trashBtn = qsa('.icon-btn', el)[1];
      editBtn.onclick = ()=> editAreaName(area.id);
      trashBtn.onclick = ()=> deleteArea(area.id);

      // upload controls
      const uploadBox = qs('.photo-upload-box', el);
      uploadBox.innerHTML = '';
      if (state.isAdminLogged){
        const g = document.createElement('button'); g.className='btn ghost'; g.innerText='Pilih dari Galeri (multiple)';
        g.onclick = ()=> { const inp = createFileInput({allowGallery:true,multiple:true,areaId:area.id, onChange: files => handleFilesSelected(area.id, files)}); inp.click(); };
        const c = document.createElement('button'); c.className='btn ghost'; c.innerText='Ambil Foto (kamera)';
        c.onclick = ()=> { const inp = createFileInput({allowGallery:false,multiple:false,areaId:area.id, onChange: files => handleFilesSelected(area.id, files)}); inp.click(); };
        uploadBox.appendChild(g); uploadBox.appendChild(c);
      } else {
        const c = document.createElement('button'); c.className='btn ghost'; c.innerText='Ambil Foto (kamera)';
        c.onclick = ()=> { const inp = createFileInput({allowGallery:false,multiple:false,areaId:area.id, onChange: files => handleFilesSelected(area.id, files)}); inp.click(); };
        uploadBox.appendChild(c);
      }

      // photos
      const photosEl = qs('.photos', el);
      qs('.photo-count', el).innerText = area.photos.length;
      area.photos.forEach(p=>{
        const item = document.createElement('div'); item.className='photo-item';
        item.dataset.photoId = p.id;
        const img = document.createElement('img'); img.src = p.url; item.appendChild(img);
        const actions = document.createElement('div'); actions.className='actions';
        const btnDel = document.createElement('button'); btnDel.className='icon-btn'; btnDel.title='Hapus Foto'; btnDel.innerHTML='<i class="fa fa-trash icon-trash"></i>';
        btnDel.onclick = (ev)=>{ ev.stopPropagation(); if(confirm('Hapus foto ini?')){ const i = area.photos.findIndex(pp=>pp.id===p.id); if(i>=0){ revoke(area.photos[i].url); area.photos.splice(i,1); renderAreas(); } } };
        const btnEdit = document.createElement('button'); btnEdit.className='icon-btn'; btnEdit.title='Tulis deskripsi'; btnEdit.innerHTML='<i class="fa fa-pen icon-pencil"></i>';
        btnEdit.onclick = (ev)=>{ ev.stopPropagation(); const txt = prompt('Masukkan deskripsi (tanpa batas):', p.desc||''); if(txt!==null){ p.desc = txt; renderAreas(); } };
        actions.appendChild(btnDel); actions.appendChild(btnEdit);
        item.appendChild(actions);
        if(p.desc && p.desc.length>0){
          const d = document.createElement('div'); d.style.padding='6px'; d.style.fontSize='13px'; d.style.textAlign='left'; d.innerText = p.desc;
          item.appendChild(d);
        }
        photosEl.appendChild(item);
      });

      const descTa = qs('.area-desc', el);
      descTa.value = area.description || '';
      descTa.oninput = ()=> area.description = descTa.value;
      qs('.btn-save-desc', el).onclick = ()=> { area.description = descTa.value; alert('Deskripsi area disimpan'); };

      areasEl.appendChild(el);
    });
  }

  // gps tracking
  let watchId = null;
  function startTracking(){
    if(!navigator.geolocation){ alert('Geolocation tidak tersedia'); return; }
    trackStatus.innerText = 'GPS: aktif (mengambil lokasi...)';
    btnStartTrack.classList.add('hidden'); btnStopTrack.classList.remove('hidden');
    watchId = navigator.geolocation.watchPosition(pos=>{
      const lat = pos.coords.latitude, lon = pos.coords.longitude, t=pos.timestamp;
      coordsEl.innerText = lat.toFixed(6)+', '+lon.toFixed(6)+' • '+ new Date(t).toLocaleTimeString();
      state.gpsPath.push({lat,lon,timestamp: t});
    }, err=>{ console.warn(err); trackStatus.innerText = 'GPS: error/izin'; }, {enableHighAccuracy:true, maximumAge:2000, timeout:8000});
  }
  function stopTracking(){ if(watchId && navigator.geolocation) navigator.geolocation.clearWatch(watchId); watchId=null; trackStatus.innerText='GPS: dihentikan'; btnStartTrack.classList.remove('hidden'); btnStopTrack.classList.add('hidden'); }

  // signature canvas
  const ctx = sigCanvas.getContext('2d');
  let drawing=false, last=null;
  function getPos(e){
    const r = sigCanvas.getBoundingClientRect();
    const x = (e.touches?e.touches[0].clientX:e.clientX)-r.left;
    const y = (e.touches?e.touches[0].clientY:e.clientY)-r.top;
    return {x,y};
  }
  function start(e){ drawing=true; last=getPos(e); e.preventDefault(); disableScroll(true); }
  function move(e){ if(!drawing) return; const p=getPos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.lineCap='round'; ctx.lineWidth=2.6; ctx.strokeStyle='#111'; ctx.stroke(); last=p; e.preventDefault(); }
  function end(e){ drawing=false; last=null; disableScroll(false); }
  sigCanvas.addEventListener('mousedown', start); sigCanvas.addEventListener('mousemove', move); sigCanvas.addEventListener('mouseup', end);
  sigCanvas.addEventListener('touchstart', start, {passive:false}); sigCanvas.addEventListener('touchmove', move, {passive:false}); sigCanvas.addEventListener('touchend', end);

  function disableScroll(flag){ document.body.style.overflow = flag? 'hidden': ''; document.documentElement.style.overflow = flag? 'hidden' : ''; }
  btnClearSig.onclick = ()=>{ ctx.clearRect(0,0,sigCanvas.width,sigCanvas.height); state.signatureDataUrl=null; sigPreview.innerHTML=''; };
  btnSaveSig.onclick = ()=>{ const url = sigCanvas.toDataURL('image/png'); state.signatureDataUrl = url; sigPreview.innerHTML = '<img src="'+url+'" style="width:140px;height:60px;object-fit:contain">'; alert('Tanda tangan disimpan'); };

  // PDF generation: use ArrayBuffer -> Blob MIME application/pdf to avoid gallery issues
  async function generatePDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'mm', format:'a4'});
    const officer = officerName.value || 'Petugas';
    const shift = shiftInput.value || '';
    const tanggal = tanggalInput.value || (new Date()).toISOString().slice(0,10);
    const waktuNow = new Date().toLocaleTimeString();

    // Capture profile photo (camera-only for user, gallery allowed for admin)
    try {
      const profileFile = await captureProfilePhoto(state.isAdminLogged);
      if(profileFile){
        const imgData = await fileToDataUrl(profileFile);
        // Cover header: colored bar (table-like)
        doc.setFillColor(12,37,79);
        doc.rect(10,10,190,34,'F');
        doc.setTextColor(255,255,255);
        doc.setFontSize(14);
        doc.text(officer, 14, 28);
        doc.setFontSize(10);
        doc.text('Shift: '+shift+' • Tanggal: '+tanggal+' • Jam: '+waktuNow, 14, 36);
        // profile image top-right
        try {
          const props = doc.getImageProperties(imgData);
          const w = 48;
          const h = (props.height/props.width)*w;
          doc.addImage(imgData, 'PNG', 150, 12, w, h);
        } catch(e){ console.warn('img add cover err', e); }
      } else {
        doc.setFontSize(12);
        doc.text(officer, 14, 28);
        doc.setFontSize(10);
        doc.text('Shift: '+shift+' • Tanggal: '+tanggal+' • Jam: '+waktuNow, 14, 36);
      }
    } catch(e){
      console.warn('capture profile err', e);
    }

    doc.addPage();

    // content: each area and photos
    for(const a of state.areas){
      doc.setFontSize(13); doc.setTextColor(12,12,12);
      doc.text('Area: '+a.name, 12, 18);
      doc.setFontSize(10);
      const lines = doc.splitTextToSize(a.description || '', 180);
      doc.text(lines, 12, 26);
      let y = 26 + (lines.length*5);
      for(const p of a.photos){
        if(y > 250){ doc.addPage(); y = 20; }
        try {
          const data = await urlToDataUrl(p.url);
          const props = doc.getImageProperties(data);
          const pw = 60;
          const ph = (props.height/props.width)*pw;
          doc.addImage(data, 'JPEG', 12, y, pw, ph);
          if(p.desc && p.desc.length>0){
            doc.setFontSize(9);
            doc.text(p.desc, 12 + pw + 6, y + 6, {maxWidth: 180 - pw - 12});
          }
          y += Math.max(ph, 36) + 8;
        } catch(e){ console.warn('add photo err', e); }
      }
      doc.addPage();
    }

    // final page: signature & officer
    doc.setFontSize(12); doc.text('Tanda Tangan Petugas:', 12, 30);
    if(state.signatureDataUrl){
      try{ doc.addImage(state.signatureDataUrl, 'PNG', 12, 38, 80, 30); }catch(e){ console.warn('sig add error', e); }
    }
    doc.setLineWidth(0.6); doc.line(12, 80, 110, 80);
    doc.setFontSize(11); doc.text(officer, 12, 88);

    // GPS summary
    doc.setFontSize(9); doc.text('GPS path (latest 10):', 12, 100);
    const gpsSample = state.gpsPath.slice(-10).map(g=>`${g.lat.toFixed(6)},${g.lon.toFixed(6)} @ ${new Date(g.timestamp).toLocaleString()}`);
    doc.setFontSize(8); doc.text(doc.splitTextToSize(gpsSample.join('\n'), 180), 12, 106);

    // output -> arraybuffer -> blob (application/pdf)
    const ab = doc.output('arraybuffer');
    const blob = new Blob([ab], {type: 'application/pdf'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'laporan_patroli_'+ (new Date()).toISOString().slice(0,19).replace(/[:T]/g,'_') +'.pdf';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ try{ document.body.removeChild(a); URL.revokeObjectURL(url); }catch(e){} }, 1500);
  }

  // capture profile photo
  async function captureProfilePhoto(allowGallery){
    return new Promise(resolve=>{
      const inp = document.createElement('input');
      inp.type = 'file'; inp.accept = 'image/*';
      if(!allowGallery) inp.setAttribute('capture','environment');
      inp.style.display='none';
      document.body.appendChild(inp);
      inp.addEventListener('change', e=>{
        const f = e.target.files && e.target.files[0];
        try{ document.body.removeChild(inp); }catch(e){}
        resolve(f || null);
      });
      inp.click();
      setTimeout(()=>{ try{ if(document.body.contains(inp)) document.body.removeChild(inp); }catch(e){} }, 30000);
    });
  }

  // utils
  function fileToDataUrl(file){ return new Promise((res,rej)=>{ const fr = new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
  function urlToDataUrl(url){ return fetch(url).then(r=>r.blob()).then(b=>new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(b); })); }

  // deep clean modal handlers
  function showDeepClean(){ deepCleanModal.classList.remove('hidden'); deepCleanModal.setAttribute('aria-hidden','false'); }
  function hideDeepClean(){ deepCleanModal.classList.add('hidden'); deepCleanModal.setAttribute('aria-hidden','true'); }
  btnDeepClean.onclick = showDeepClean;
  btnCancelDeep.onclick = hideDeepClean;
  btnConfirmDeep.onclick = ()=> {
    // perform deep clean
    // revoke urls
    state.areas.forEach(a=> a.photos.forEach(p=> revoke(p.url) ));
    state.areas = []; state.gpsPath = []; state.signatureDataUrl = null;
    // remove admin password from memory (require new setup)
    window.__patrol_admin_password = null;
    state.isAdminLogged = false;
    // clear UI inputs
    adminPasswordInput.value=''; officerName.value=''; shiftInput.value=''; tanggalInput.value='';
    // show admin login box so new password can be set by admin flow (but no password exists)
    adminLoginBox.classList.remove('hidden');
    btnAdminLogout.classList.add('hidden'); qs('#btnAdminLogin').classList.remove('hidden');
    renderAreas();
    hideDeepClean();
    alert('Deep Clean-up selesai. Aplikasi kembali seperti baru; akses admin dihapus. Silakan atur password baru jika perlu.');
  };

  // admin login flow (no password printed)
  btnAdminLogin.onclick = ()=>{
    const val = adminPasswordInput.value;
    if(!val){ alert('Masukkan password (atau lakukan Deep Clean-up untuk reset akses)'); return; }
    if(window.__patrol_admin_password === null){
      // if no admin password exists, set it (first setup)
      window.__patrol_admin_password = val; state.isAdminLogged = true;
      adminPasswordInput.value = '';
      btnAdminLogout.classList.remove('hidden'); btnAdminLogin.classList.add('hidden');
      alert('Admin baru berhasil dibuat & login');
      renderAreas();
      return;
    }
    if(val === window.__patrol_admin_password){ state.isAdminLogged=true; adminPasswordInput.value=''; btnAdminLogout.classList.remove('hidden'); btnAdminLogin.classList.add('hidden'); alert('Login admin berhasil'); renderAreas(); }
    else alert('Password salah');
  };
  btnAdminLogout.onclick = ()=>{ state.isAdminLogged=false; btnAdminLogout.classList.add('hidden'); btnAdminLogin.classList.remove('hidden'); renderAreas(); };

  // UI wiring
  btnAddArea.onclick = ()=>{ const nm = areaNameInput.value.trim(); addArea(nm || undefined); areaNameInput.value=''; };
  btnModeUser.onclick = ()=>{ state.mode='user'; adminLoginBox.classList.add('hidden'); state.isAdminLogged=false; renderAreas(); };
  btnModeAdmin.onclick = ()=>{ state.mode='admin'; adminLoginBox.classList.remove('hidden'); renderAreas(); };

  btnStartTrack.onclick = startTracking;
  btnStopTrack.onclick = stopTracking;
  btnGeneratePDF.onclick = generatePDF;

  tabAreas.onclick = ()=>{ areasSection.classList.remove('hidden'); signatureSection.classList.add('hidden'); };
  tabSignature.onclick = ()=>{ areasSection.classList.add('hidden'); signatureSection.classList.remove('hidden'); };

  // prevent localStorage writes (defensive)
  try{ if(window.localStorage) Object.defineProperty(window, 'localStorage', { get: ()=>undefined }); }catch(e){}

  // initial render
  renderAreas();

  // expose for debug if needed
  window.__patrol_state = state;
  window.__patrol_api = { addArea, editAreaName, deleteArea, renderAreas, generatePDF };

})(); // end
</script>
</body>
</html>